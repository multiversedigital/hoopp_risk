# Tab 3: Stress Testing - è®¾è®¡æ–‡æ¡£

## 1. ä¸šåŠ¡ç›®æ ‡

å±•ç¤ºåŸºé‡‘åœ¨**å®è§‚å†²å‡»åœºæ™¯**ä¸‹çš„è¡¨ç°ï¼Œå›ç­”å…³é”®é—®é¢˜ï¼š
- å¦‚æœåˆ©ç‡ä¸Šå‡ 100bpï¼ŒåŸºé‡‘ä¼šæŸå¤±å¤šå°‘ï¼Ÿ
- å¦‚æœè‚¡å¸‚ä¸‹è·Œ 20%ï¼ŒFunded Status è¿˜èƒ½ä¿æŒ 100% ä»¥ä¸Šå—ï¼Ÿ
- å“ªäº›èµ„äº§å¯¹å†²å‡»æœ€æ•æ„Ÿï¼Ÿ

è¿™æ˜¯ **è´Ÿå€ºé©±åŠ¨æŠ•èµ„ (LDI)** æ¡†æ¶çš„æ ¸å¿ƒâ€”â€”ä¸åªçœ‹èµ„äº§æ³¢åŠ¨ï¼Œæ›´çœ‹èµ„äº§ä¸è´Ÿå€ºçš„åŒ¹é…ã€‚

---

## 2. UI å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Stressed Funded Status]  [Asset Î”]  [Liability Î”]  [Surplus Î”]   â”‚  â† Row 1: 4ä¸ª KPI
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   â”‚                                                â”‚
â”‚   ğŸšï¸ Scenario     â”‚   ğŸ“Š P&L Waterfall (ç€‘å¸ƒå›¾)                    â”‚  â† Row 2
â”‚   Controls        â”‚                                                â”‚
â”‚                   â”‚   Baseline â†’ Rate â†’ Equity â†’ Inflation â†’ Final â”‚
â”‚   [Preset â–¼]      â”‚                                                â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚                                                â”‚
â”‚   Rate: [-100,+100] bp                                             â”‚
â”‚   Equity: [-30,+30] %                                              â”‚
â”‚   Inflation: [-2,+2] %                                             â”‚
â”‚                   â”‚                                                â”‚
â”‚   [Reset Button]  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   â”‚                                                â”‚
â”‚                   â”‚   ğŸ“‹ Top Movers Table                          â”‚
â”‚                   â”‚   (5 biggest gains + 5 biggest losses)         â”‚
â”‚                   â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¯”ä¾‹**: å·¦ 35% (sliders) / å³ 65% (å›¾è¡¨)

---

## 3. ç»„ä»¶è¯¦è§£

### Row 1: KPI å¡ç‰‡ (4ä¸ªï¼Œå¸¦ delta æ˜¾ç¤ºå˜åŒ–)

| æŒ‡æ ‡ | è®¡ç®— | Delta é¢œè‰²é€»è¾‘ |
|------|------|----------------|
| Stressed Funded Status | stressed_assets / stressed_liabilities | çº¢è·Œç»¿æ¶¨ |
| Asset Î” | stressed_assets - baseline_assets | çº¢è·Œç»¿æ¶¨ |
| Liability Î” | stressed_liabilities - baseline_liabilities | çº¢æ¶¨ç»¿è·Œ (è´Ÿå€ºæ¶¨æ˜¯åäº‹) |
| Surplus Î” | stressed_surplus - baseline_surplus | çº¢è·Œç»¿æ¶¨ |

### Row 2 å·¦: Scenario Controls

#### é¢„è®¾åœºæ™¯ Dropdown

| åœºæ™¯å | Rate (bp) | Equity (%) | Inflation (%) | è¯´æ˜ |
|--------|-----------|------------|---------------|------|
| Custom | - | - | - | æ‰‹åŠ¨è°ƒèŠ‚ |
| 2008 Financial Crisis | +50 | -40 | -1 | ä¿¡ç”¨å±æœº + è‚¡ç¾ |
| Stagflation | +100 | -15 | +3 | æ»èƒ€ï¼šé«˜é€šèƒ€ + ä½å¢é•¿ |
| Rate Hike Shock | +150 | -10 | +0.5 | å¤®è¡Œæ¿€è¿›åŠ æ¯ |
| Market Rally | -25 | +20 | +0.5 | é£é™©åå¥½å›å‡ |
| Deflation Scare | -50 | -10 | -2 | é€šç¼©æ‹…å¿§ |

#### Sliders

| æ§ä»¶ | èŒƒå›´ | é»˜è®¤ | æ­¥é•¿ | è¯´æ˜ |
|------|------|------|------|------|
| Interest Rate | -200 to +200 bp | 0 | 5 | åˆ©ç‡å†²å‡» |
| Equity | -50% to +50% | 0 | 1 | è‚¡å¸‚å†²å‡» |
| Inflation | -3% to +3% | 0 | 0.1 | é€šèƒ€å†²å‡» |

#### Reset Button
ä¸€é”®å°†æ‰€æœ‰ slider å½’é›¶ï¼Œåœºæ™¯åˆ‡å› Customã€‚

### Row 2 å³ä¸Š: P&L Waterfall ç€‘å¸ƒå›¾

å±•ç¤º P&L åˆ†è§£ï¼š
```
Baseline Assets â†’ (+/-) Rate Impact â†’ (+/-) Equity Impact â†’ (+/-) Inflation Impact â†’ Final Assets
```

| é˜¶æ®µ | é¢œè‰² |
|------|------|
| Baseline | ç° #8a9bb0 |
| Positive Î” | ç»¿ #00c9a7 |
| Negative Î” | çº¢ #e74c3c |
| Final | å†°è“ #00b4d8 |

### Row 2 å³ä¸‹: Top Movers Table

| åˆ— | è¯´æ˜ |
|----|------|
| Asset | èµ„äº§åç§° |
| Class | èµ„äº§ç±»åˆ« |
| Baseline | å‹åŠ›å‰å¸‚å€¼ ($B) |
| Stressed | å‹åŠ›åå¸‚å€¼ ($B) |
| P&L | å˜åŒ–é‡‘é¢ ($M) |
| P&L % | å˜åŒ–ç™¾åˆ†æ¯” |

æ˜¾ç¤ºï¼šTop 5 Gains (ç»¿) + Top 5 Losses (çº¢)ï¼Œå…± 10 è¡Œ

---

## 4. æ•°æ®æµ

```
User selects preset OR moves slider
       â†“
Preset â†’ è‡ªåŠ¨å¡«å…… slider å€¼
       â†“
st.slider â†’ s_rate, s_eq, s_inf
       â†“
engine.calculate_metrics(df_day, s_rate, s_eq, s_inf)
       â†“
df_stressed (å¸¦ mtm_stressed åˆ—)
       â†“
è®¡ç®— KPIs + Waterfall + Top Movers
       â†“
æ¸²æŸ“ UI
```

---

## 5. æ•°æ®æ¥æº

| UI ç»„ä»¶ | æ•°æ®æº | è¯´æ˜ |
|---------|--------|------|
| Baseline KPIs | `ctx['total_assets']`, `ctx['total_liabilities']`, `ctx['funded_status']`, `ctx['surplus']` | å·²æœ‰ |
| Baseline è¡Œçº§æ•°æ® | `ctx['df_day']` | å·²æœ‰ |
| Stressed æ•°æ® | `engine.calculate_metrics()` å®æ—¶è®¡ç®— | å·²æœ‰å‡½æ•° |
| Waterfall åˆ†è§£ | éœ€è¦æ–°å¢é€»è¾‘ | Tab å†…è®¡ç®— |

---

## 6. Waterfall è®¡ç®—é€»è¾‘

```python
# åˆ†åˆ«è®¡ç®—æ¯ä¸ªå› å­çš„ç‹¬ç«‹å½±å“
rate_only_pnl = (df['market_exposure_cad'] * (-df['duration'] * s_rate/10000)).sum()
equity_only_pnl = (df['market_exposure_cad'] * (df['equity_beta'] * s_eq/100)).sum()
inflation_only_pnl = (df['market_exposure_cad'] * (df['inflation_beta'] * s_inf/100)).sum()

# æ³¨æ„ï¼šä¸‰è€…ç›¸åŠ  â‰ˆ æ€» P&Lï¼ˆçº¿æ€§è¿‘ä¼¼ï¼Œå¿½ç•¥äº¤å‰é¡¹ï¼‰
```

---

## 7. é¢œè‰²è§„èŒƒ

| å…ƒç´  | é¢œè‰² |
|------|------|
| é¡µé¢èƒŒæ™¯ | `#0f1923` |
| å¡ç‰‡èƒŒæ™¯ | `#162232` |
| ä¸» Accent | `#00b4d8` (å†°è“) |
| Positive P&L | `#00c9a7` (ç»¿) |
| Negative P&L | `#e74c3c` (çº¢) |
| Baseline/Neutral | `#8a9bb0` (ç°è“) |

---

## 8. å®ç°æ¸…å•

- [x] è®¾è®¡æ–‡æ¡£
- [ ] `tabs/tab_stress.py` - render å‡½æ•°
- [ ] éªŒè¯ `engine.calculate_metrics()` èƒ½å¤„ç†è´Ÿå€ºè¡Œ

---

## 9. äº®ç‚¹

| ç‚¹ | ä»·å€¼ |
|----|------|
| é¢„è®¾åœºæ™¯ | å¿«é€Ÿæ¼”ç¤ºå†å²å±æœºæƒ…æ™¯ï¼Œé¢è¯•åŠ åˆ† |
| å®æ—¶äº¤äº’ | Slider æ‹–åŠ¨å³æ—¶åé¦ˆï¼Œå±•ç¤ºè®¡ç®—èƒ½åŠ› |
| LDI è§†è§’ | åŒæ—¶å‹èµ„äº§å’Œè´Ÿå€ºï¼Œä¸åªçœ‹èµ„äº§ |
| Waterfall åˆ†è§£ | æ¸…æ™°å±•ç¤ºæ¯ä¸ªé£é™©å› å­çš„è´¡çŒ® |
| Top Movers | å¿«é€Ÿå®šä½é£é™©é›†ä¸­ç‚¹ |
