# generate_data.py — 逻辑文档

## 一、整体职责

离线预生成脚本。运行一次，输出两个 CSV 到 `data/`，之后被 `engine.py` 读取。运行时不参与 app 的任何逻辑。

```
python generate_data.py
    ↓
data/hoopp_positions_sample.csv   ← 10天 × ~250行/天 的仓库数据
data/policy_limit_management.csv  ← 静态的政策限额表
```

---

## 二、配置参数

| 参数 | 值 | 含义 |
|---|---|---|
| `NUM_DAYS` | 10 | 生成的工作日天数 |
| `ROWS_PER_DAY` | 200 | 每天资产端的目标行数（实际行数按权重加权分配，总行数约 200） |
| `TOTAL_ASSETS_CAD` | 124,000 | 资产基准总额（单位：百万 CAD，即 $124B）。每日实际值围绕此波动 |
| `TOTAL_LIABILITY_CAD` | 110,800 | 负债固定总额（单位：百万 CAD，即 $110.8B）。每天不变 |
| `DAILY_DRIFT_SIGMA` | 0.00316 | 资产每日漂移的标准差。由 `0.01 / sqrt(10)` 反推，目的是让 10 天累积漂移的标准差约为 1% |
| `np.random.seed(42)` | 42 | 固定种子，保证每次生成结果完全一致，方便调试 |

---

## 三、日期生成

```
_generate_business_dates(base_date=2026-01-30, n_days=10)
```

从 `base_date`（周五）往回逐日检查，跳过周六周日，收集到 10 个工作日为止。返回的列表**最新日在前**。

实际产出：

```
2026-01-30 (Fri)
2026-01-29 (Thu)
2026-01-28 (Wed)
2026-01-27 (Tue)
2026-01-26 (Mon)
2026-01-23 (Fri)  ← 跳过 24-25 weekend
2026-01-22 (Thu)
2026-01-21 (Wed)
2026-01-20 (Tue)
2026-01-19 (Mon)
```

> **为什么 base_date 是 1/30 而不是 1/31？**
> 1/31 是周六。如果以周六为起点，它本身会被跳过，最新日会落在 1/30。直接把 base_date 设为 1/30，逻辑更清楚。

---

## 四、资产漂移模型（总额层级）

### 问题背景

如果波动只加在位置级别（每行 `× Normal(1, σ)`），由于每天有 ~200 行求和，根据大数定律噪声会被平滑掉，日总额几乎不动。所以波动必须加在**总额层级**。

### 模型：居中随机游走

```
Step 1: 生成 10 天的独立噪声
        ε₁, ε₂, ..., ε₁₀  ~  Normal(0, 0.00316)

Step 2: 累积求和 → 随机游走路径
        drift_t = ε₁ + ε₂ + ... + εₜ

Step 3: 居中（减去路径均值）
        drift_t -= mean(drift)
        → 路径围绕 0 上下波动，不会单向漂移

Step 4: 反转顺序
        累积和的 [0] 是最早的天，但 business_dates 列表最新在前，
        所以 reverse 一下对齐。

Step 5: 计算当日总额
        daily_total = 124000 × (1 + drift_t)
```

### 参数推导

目标：10 天内漂移幅度大部分在 ±1%，偶尔到 ±2%。

随机游走累积 N 步后标准差 = `σ × √N`。反推每日 σ：

```
σ × √10 ≈ 0.01
σ ≈ 0.01 / √10 ≈ 0.00316
```

模拟 10,000 次验证：
- 67% 的路径终点落在 ±1% 以内
- 95% 的路径在整个 10 天内不超过 ±2.1%
- 99% 不超过 ±2.7%

### 居中的效果

不居中时累积和天然会单向漂移（这次种子刚好是向上漂到 +2%）。居中之后路径在 0 两侧都会波动，视觉上更像"围绕基准价上下震荡"。

> **注意**：居中改变了路径的形状，但不影响相邻两天之间的漂移幅度（仍然是 σ 级别的日变动），也不影响整体波动范围。

---

## 五、资产位置生成（行级别）

对每天的每个 `ASSET_PROFILE`，循环生成若干行：

```
target_amt  = daily_total × profile['w']         ← 用当日波动后的总额分配
n_rows      = max(2, int(200 × |profile['w']|))  ← 权重越大，行数越多
每行 mtm    = (target_amt / n_rows) × Normal(1, 0.05)  ← 位置级别小噪声
```

位置噪声标准差是 0.05（±5%），不是 0.1。因为总额波动已经在上层处理了，这层噪声只是模拟单个持仓的正常日常抖动，不需要大。

### 衍生字段的计算逻辑

| 字段 | 公式 | 说明 |
|---|---|---|
| `market_exposure_cad` | `mtm × lev` | 衍生品敞口放大。Futures 的 lev=20，所以敞口是 MTM 的 20 倍 |
| `fx_exposure_cad` | `market_exposure × fx` | fx 为负数（Cash & Funding 的 FX Forwards）时，产生负敞口，起对冲作用 |
| `duration` | `profile.dur + Normal(0, 0.5)` | 在基准久期附近波动 |
| `equity_beta` | `profile.beta + Normal(0, 0.1)` | 同上 |
| `carbon_intensity` | `Normal(base, 5)` 取非负 | Infra 基准 5，其余 20 |
| `esg_score` | `Normal(base, 8)` 取 ≤100 | Infra/RE 基准 85，其余 75 |
| `asset_name` | `"{sub}_{random 4 位数}"` | 每行随机后缀，**不能跨天追踪同一持仓**（已知限制） |

### ASSET_PROFILES 各类别的关键特征

| 类别 | 权重 | 核心风险因子 | 特殊点 |
|---|---|---|---|
| Fixed Income - Nominal | 30% | Duration=8 | 主要的利率对冲仓 |
| Fixed Income - Real Return | 12% | Duration=14, InfBeta=1.0 | 通胀对冲，久期最长的资产 |
| Public Equities - Dev | 15%+10%+8% | Beta=1.0~1.2 | 全部或部分 FX 暴露 |
| Public Equities - Futures | 5% | Lev=20 | 高杠杆衍生品，敞口远大于 MTM |
| Private RE | 18% | InfBeta=0.6, Beta=0.4 | 通胀敏感的实物资产 |
| Private Infra | 7% | InfBeta=0.5, Beta=0.3 | ESG 评分最高 |
| Private Credit | 7% | Duration=4 | 短久期信用 |
| Cash & Funding | -12% | Lev=5, FX=-1.0 | 负权重。FX Forward 对冲仓，产生负 FX 敞口 |

---

## 六、负债生成

每天固定生成 2 行：

| 字段 | Active_Members | Retired_Members |
|---|---|---|
| `mtm_cad` | -55,400 | -55,400 |
| `duration` | 14.5 | 11.2 |
| 其余风险因子 | 全部为 0 | 全部为 0 |

### 设计决策：为什么负债固定不波动

精算负债（Defined Benefit Obligation）基于长期精算假设（退休年龄、寿命、贴现率等），不像市场资产那样每天随行情波动。实际中精算负债通常按季度或年度重新估算。

固定负债 + 波动资产的组合效果：

```
资产 = 122,528 → Funded Status = 110.6%
资产 = 124,000 → Funded Status = 111.9%  ← 基准
资产 = 125,678 → Funded Status = 113.4%
```

Funded Status 随资产波动而自然变化，时间序列图上有实际可见的起伏。如果负债也跟着动（之前的逻辑：负债 = 资产/1.11），FS 每天都约等于 111%，图表上是一条平线。

> **已知简化**：负债的 `inflation_beta` 设为 0。实际精算负债对通胀有隐含敏感度（COLA 条款），将来如果要让压力测试中通胀冲击也影响负债侧，需要在这里加回去。

---

## 七、政策限额表

静态表，每次生成内容相同。两种类型：

**Asset_Mix** — 各资产类别的配置限制（target / min / max），来自 SIPP。

**Global_Limit** — 基金级别的全局限制：
- `FX_Net_Exposure`：净外汇敞口上限 15%
- `Funded_Status`：充足率范围 100%~150%，目标 111%

---

## 八、输出格式

`hoopp_positions_sample.csv` 的列：

```
timestamp | asset_name | plan_category | asset_class | sub_asset_class |
sector | geography | country | currency | mtm_cad |
market_exposure_cad | fx_exposure_cad | duration | equity_beta |
inflation_beta | fx_delta | carbon_intensity | esg_score
```

共 18 列，2500 行（10 天 × 约 250 行/天，包括资产和负债）。

---

## 九、将来可完善的方向

1. **持仓追踪**：当前 `asset_name` 每行随机后缀，无法跨天追踪同一仓位。可以预生成一个固定的仓位列表，每天对同一仓位生成价格变动。

2. **负债波动**：加入 `inflation_beta` 到负债端，让通胀冲击也能影响负债侧的压力测试。

3. **事件驰序**：在某一天的数据中注入异常（如某类别权重突然超限），用于测试合规预警的响应。

4. **更长时间窗口**：目前 10 天。如果要测试月度趋势图，可以把 `NUM_DAYS` 拉到 21（一个月工作日），`DAILY_DRIFT_SIGMA` 相应调小。

5. **资产类别级别的独立漂移**：当前所有类别按同一个 drift 比例波动。实际中 Equity 波动性远大于 Fixed Income，可以给每个类别分配自己的 sigma。
