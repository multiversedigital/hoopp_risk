# Tab 4: Data Pipeline - 设计文档

## 1. 业务目标

展示**数据自动化与质量监控**能力，解决风险团队的痛点：
- 数据从哪来？是否完整？
- 有没有空值、异常值？
- 最后更新时间是什么时候？

这是展示 **"终结 Excel 对账工作"** 的技术能力。

---

## 2. UI 布局

```
┌─────────────────────────────────────────────────────────────────┐
│  [Total Records]  [Missing Rate]  [Anomalies]  [Last Update]    │  ← Row 1: 4个 KPI 卡片
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📊 Data Quality by Column                                      │  ← Row 2: 列级质量表
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Column        │ Type    │ Missing │ Anomaly │ Status   │   │
│  │ mtm_cad       │ float64 │ 0       │ 2       │ 🟡 WARN  │   │
│  │ duration      │ float64 │ 0       │ 0       │ 🟢 OK    │   │
│  │ fx_exposure   │ float64 │ 3       │ 0       │ 🔴 ISSUE │   │
│  │ ...           │         │         │         │          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📈 Data Coverage Timeline                                      │  ← Row 3: 时间覆盖图
│  (每天有多少条记录的柱状图)                                       │
│                                                                 │
├──────────────────────────────┬──────────────────────────────────┤
│                              │                                  │
│  🔍 Anomaly Details          │  📋 Data Source Info             │  ← Row 4: 左右分
│  (异常值明细表)               │  (数据源元信息)                   │
│                              │                                  │
└──────────────────────────────┴──────────────────────────────────┘
```

---

## 3. 组件详解

### Row 1: KPI 卡片 (4个)

| 指标 | 计算 | 说明 |
|------|------|------|
| Total Records | `len(df_all)` | 总数据行数 |
| Missing Rate | `df.isnull().sum() / total` | 缺失值占比 |
| Anomalies | 异常值检测计数 | 超出 3σ 或业务规则的值 |
| Last Update | `df['timestamp'].max()` | 最新数据日期 |

### Row 2: Data Quality Table (列级扫描)

| 列 | 说明 |
|----|------|
| Column | 字段名 |
| Type | 数据类型 (float64, object, datetime64) |
| Missing | 缺失值数量 |
| Missing % | 缺失率 |
| Anomalies | 异常值数量 |
| Status | 🟢 OK / 🟡 WARN / 🔴 ISSUE |

**状态判断规则：**
```
Missing > 0 OR Anomalies > 5  →  🔴 ISSUE
Anomalies > 0                 →  🟡 WARN
else                          →  🟢 OK
```

### Row 3: Data Coverage Timeline

- **X 轴**: 日期 (10 天)
- **Y 轴**: 每天记录数
- **柱状图**: 展示数据完整性
- **预期线**: 每天应有 ~200 条记录

### Row 4 左: Anomaly Details

如果有异常值，展示明细：
| Date | Column | Value | Issue |
|------|--------|-------|-------|
| 2026-01-25 | mtm_cad | -999999 | Extreme negative |
| 2026-01-27 | duration | 150 | Exceeds max (30) |

### Row 4 右: Data Source Info

```
📁 Source Files:
  • hoopp_positions_sample.csv (2,000 rows)
  • policy_limit_management.csv (8 rows)

📅 Date Range: 2026-01-22 to 2026-01-31 (10 days)

🔄 Refresh: Manual (CSV upload)
   Future: SQL / API integration
```

---

## 4. 异常值检测规则

| 字段 | 规则 | 说明 |
|------|------|------|
| `mtm_cad` | `abs(value) > 50000` | 单仓位超 $50B 异常 |
| `duration` | `value < -5 or value > 30` | 久期范围 |
| `equity_beta` | `value < -2 or value > 3` | Beta 范围 |
| `fx_exposure_cad` | `abs(value) > total_assets * 0.3` | FX 超资产 30% |
| 通用数值列 | `abs(z-score) > 3` | 3 倍标准差 |

---

## 5. 数据来源

| 组件 | 数据源 | 需新增? |
|------|--------|---------|
| KPI 卡片 | `ctx['df_all']` | ❌ 已有 |
| 质量表 | `ctx['df_all']` 列分析 | ✅ Tab 内计算 |
| 时间柱状图 | `df_all.groupby('timestamp')` | ✅ Tab 内计算 |
| 异常明细 | 异常检测结果 | ✅ Tab 内计算 |

**不需要改 engine.py**，所有计算在 Tab 内完成。

---

## 6. 颜色规范

| 元素 | 颜色 |
|------|------|
| 🟢 OK | `#00c9a7` |
| 🟡 WARN | `#f9a825` |
| 🔴 ISSUE | `#e74c3c` |
| 柱状图 | `#00b4d8` |
| 预期线 | `#f9a825` (虚线) |

---

## 7. 实现清单

- [x] 设计文档
- [ ] `tabs/tab_pipeline.py` - render 函数

---

## 8. 亮点

| 点 | 价值 |
|----|------|
| **数据治理** | 展示对数据质量的重视 |
| **自动化检测** | 异常值自动扫描，不用人工检查 |
| **可视化覆盖** | 一眼看出哪天数据缺失 |
| **元数据展示** | 专业的数据管理视角 |
| **扩展性暗示** | "Future: SQL/API" 展示架构思维 |

---

## 9. 演示话术

> "这个 Tab 展示数据管道的健康状况。在真实环境中，数据会从 SimCorp、Bloomberg 等系统自动流入。这里我用 CSV 模拟，但架构是一样的。
> 
> 你可以看到每列的数据质量——有没有空值、异常值。如果有问题，系统会自动标红，风险经理不用手动检查 Excel。"
